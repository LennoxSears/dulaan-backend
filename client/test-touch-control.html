<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Touch Control Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .log { background-color: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .controls { margin: 20px 0; }
        .controls button { margin: 5px; padding: 10px 15px; }
        .slider-container { margin: 20px 0; }
        .slider { width: 300px; margin: 10px; }
        .value-display { font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Touch Control Flow Test</h1>
    
    <div id="status" class="status info">Loading...</div>
    
    <div class="controls">
        <h3>Touch Control Test</h3>
        <button onclick="testTouchValueSetting()">Test Touch Value Setting</button>
        <button onclick="testIntervalWriting()">Test Interval Writing</button>
        <button onclick="testExternalControl()">Test External Control</button>
        <button onclick="startTouchMode()">Start Touch Mode</button>
        <button onclick="stopTouchMode()">Stop Touch Mode</button>
    </div>
    
    <div class="slider-container">
        <h3>Interactive Touch Control (matches stream.js pattern)</h3>
        <label for="touchSlider">Touch Value (0-100%):</label><br>
        <input type="range" id="touchSlider" class="slider" min="0" max="100" value="0" 
               oninput="updateTouchValue(this.value)">
        <div id="valueDisplay" class="value-display">Touch Value: 0% | PWM: 0</div>
    </div>
    
    <div id="log" class="log"></div>
    
    <script src="dulaan-browser-bundled.js"></script>
    <script>
        let logDiv = document.getElementById('log');
        let statusDiv = document.getElementById('status');
        let valueDisplay = document.getElementById('valueDisplay');
        let touchControl = null;
        
        function log(message) {
            console.log(message);
            logDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function setStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }
        
        function updateTouchValue(value) {
            // This simulates external control setting window.touchValue (like stream.js)
            window.touchValue = parseInt(value);
            const pwmValue = Math.round((window.touchValue / 100) * 255);
            valueDisplay.textContent = `Touch Value: ${window.touchValue}% | PWM: ${pwmValue}`;
            
            if (touchControl && touchControl.isRunning()) {
                log(`External control: touchValue set to ${window.touchValue}%`);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                if (typeof window.dulaan !== 'undefined' && window.DULAAN_COMPONENTS) {
                    setStatus('✅ Bundle loaded successfully!', 'success');
                    log('Dulaan SDK loaded with touch control components');
                    
                    // Initialize touch control
                    touchControl = new window.DULAAN_COMPONENTS.TouchControl(window.dulaan);
                    log('Touch control initialized');
                    
                    // Check if global touchValue is available
                    if (typeof window.touchValue !== 'undefined') {
                        log('✅ Global touchValue available: ' + window.touchValue);
                    } else {
                        log('❌ Global touchValue not available');
                    }
                } else {
                    setStatus('❌ Bundle failed to load', 'error');
                }
            } catch (error) {
                setStatus('❌ Error: ' + error.message, 'error');
                log('Bundle test error: ' + error.message);
            }
        });
        
        function testTouchValueSetting() {
            log('\n=== Testing Touch Value Setting ===');
            
            try {
                if (!touchControl) {
                    log('❌ Touch control not initialized');
                    return;
                }
                
                // Test setValue (should only store, not write PWM)
                log('Testing setValue method (should only store value)...');
                touchControl.setValue(128);
                log('Current value: ' + touchControl.getValue());
                log('Global touchValue: ' + window.touchValue);
                
                // Test setPercentage (should only store, not write PWM)
                log('Testing setPercentage method (should only store value)...');
                touchControl.setPercentage(75);
                log('Current percentage: ' + touchControl.getPercentage() + '%');
                log('Global touchValue: ' + window.touchValue);
                
                log('✅ Touch value setting test completed');
                
            } catch (error) {
                log('❌ Touch value setting test failed: ' + error.message);
            }
        }
        
        function testIntervalWriting() {
            log('\n=== Testing Interval Writing Pattern ===');
            
            try {
                if (!touchControl) {
                    log('❌ Touch control not initialized');
                    return;
                }
                
                let writeCount = 0;
                let lastPwmValue = -1;
                
                // Mock motor write to track calls
                const originalWrite = window.dulaan.motor.write;
                window.dulaan.motor.write = async (pwm) => {
                    writeCount++;
                    lastPwmValue = pwm;
                    log(`Motor write #${writeCount}: PWM=${pwm} (from touchValue=${window.touchValue}%)`);
                    return true;
                };
                
                // Start touch control to begin interval writing
                touchControl.start();
                
                // Simulate external touch value changes
                let testStep = 0;
                const testValues = [25, 50, 75, 100, 50, 0];
                
                const testInterval = setInterval(() => {
                    if (testStep < testValues.length) {
                        window.touchValue = testValues[testStep];
                        log(`External: Set touchValue to ${window.touchValue}%`);
                        testStep++;
                    } else {
                        clearInterval(testInterval);
                        
                        setTimeout(() => {
                            touchControl.stop();
                            
                            log(`Test completed: ${writeCount} motor writes in ${testValues.length} steps`);
                            
                            if (writeCount > 0) {
                                log('✅ Interval writing test passed - PWM values written periodically');
                            } else {
                                log('❌ Interval writing test failed - no PWM values written');
                            }
                            
                            // Restore original write function
                            window.dulaan.motor.write = originalWrite;
                        }, 500);
                    }
                }, 300); // Change value every 300ms
                
            } catch (error) {
                log('❌ Interval writing test failed: ' + error.message);
            }
        }
        
        function testExternalControl() {
            log('\n=== Testing External Control Pattern ===');
            
            try {
                // Test that external code can control touch value
                log('Testing external control of touchValue...');
                
                // Simulate external control (like UI slider)
                window.touchValue = 30;
                log('External: Set touchValue to ' + window.touchValue + '%');
                
                // Check if touch control can read it
                if (touchControl) {
                    const expectedPwm = Math.round((window.touchValue / 100) * 255);
                    log('Expected PWM from touchValue: ' + expectedPwm);
                }
                
                // Test multiple external changes
                const externalValues = [10, 40, 80, 60, 20];
                let changeIndex = 0;
                
                const externalInterval = setInterval(() => {
                    if (changeIndex < externalValues.length) {
                        window.touchValue = externalValues[changeIndex];
                        const pwm = Math.round((window.touchValue / 100) * 255);
                        log(`External change #${changeIndex + 1}: touchValue=${window.touchValue}% → PWM=${pwm}`);
                        changeIndex++;
                    } else {
                        clearInterval(externalInterval);
                        log('✅ External control test completed - touchValue can be controlled externally');
                    }
                }, 200);
                
            } catch (error) {
                log('❌ External control test failed: ' + error.message);
            }
        }
        
        function startTouchMode() {
            log('\n=== Starting Touch Mode ===');
            
            try {
                if (!touchControl) {
                    log('❌ Touch control not initialized');
                    return;
                }
                
                touchControl.start();
                log('✅ Touch mode started - 100ms interval writing active');
                log('Use the slider above to control touch value externally');
                
            } catch (error) {
                log('❌ Failed to start touch mode: ' + error.message);
            }
        }
        
        function stopTouchMode() {
            log('\n=== Stopping Touch Mode ===');
            
            try {
                if (!touchControl) {
                    log('❌ Touch control not initialized');
                    return;
                }
                
                touchControl.stop();
                log('✅ Touch mode stopped - interval writing disabled');
                
            } catch (error) {
                log('❌ Failed to stop touch mode: ' + error.message);
            }
        }
    </script>
</body>
</html>