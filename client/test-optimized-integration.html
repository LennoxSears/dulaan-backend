<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Optimized Voice Control Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn.danger {
            background: #dc3545;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Optimized Voice Control Test</h1>
        <p>Testing the complete client-side implementation with all optimized components.</p>

        <div class="controls">
            <button id="testImports" class="btn">Test Imports</button>
            <button id="testRingBuffer" class="btn">Test RingBuffer</button>
            <button id="testVAD" class="btn">Test VAD Processor</button>
            <button id="testApiService" class="btn">Test API Service</button>
            <button id="testVoiceControl" class="btn">Test Voice Control</button>
            <button id="runAllTests" class="btn">Run All Tests</button>
        </div>

        <div id="results" class="status">
            Ready to run tests...
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="testsRun">0</div>
                <div>Tests Run</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="testsPassed">0</div>
                <div>Tests Passed</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="testsFailed">0</div>
                <div>Tests Failed</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="successRate">0%</div>
                <div>Success Rate</div>
            </div>
        </div>
    </div>

    <script type="module">
        let testsRun = 0;
        let testsPassed = 0;
        let testsFailed = 0;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        function updateStats() {
            document.getElementById('testsRun').textContent = testsRun;
            document.getElementById('testsPassed').textContent = testsPassed;
            document.getElementById('testsFailed').textContent = testsFailed;
            const successRate = testsRun > 0 ? Math.round((testsPassed / testsRun) * 100) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        function runTest(name, testFn) {
            testsRun++;
            try {
                log(`üß™ Running test: ${name}`);
                const result = testFn();
                if (result === false) {
                    throw new Error('Test returned false');
                }
                testsPassed++;
                log(`‚úÖ ${name} - PASSED`, 'success');
                return true;
            } catch (error) {
                testsFailed++;
                log(`‚ùå ${name} - FAILED: ${error.message}`, 'error');
                return false;
            } finally {
                updateStats();
            }
        }

        async function runAsyncTest(name, testFn) {
            testsRun++;
            try {
                log(`üß™ Running async test: ${name}`);
                const result = await testFn();
                if (result === false) {
                    throw new Error('Test returned false');
                }
                testsPassed++;
                log(`‚úÖ ${name} - PASSED`, 'success');
                return true;
            } catch (error) {
                testsFailed++;
                log(`‚ùå ${name} - FAILED: ${error.message}`, 'error');
                return false;
            } finally {
                updateStats();
            }
        }

        // Test 1: Import functionality
        async function testImports() {
            log('Testing module imports...');
            
            try {
                // Test RingBuffer import
                const { RingBuffer } = await import('./utils/audio-utils.js');
                if (!RingBuffer) throw new Error('RingBuffer not exported');
                
                // Test OptimizedStreamingProcessor import
                const { OptimizedStreamingProcessor } = await import('./core/optimized-streaming-processor.js');
                if (!OptimizedStreamingProcessor) throw new Error('OptimizedStreamingProcessor not exported');
                
                // Test OptimizedApiService import
                const { OptimizedApiService } = await import('./services/optimized-api-service.js');
                if (!OptimizedApiService) throw new Error('OptimizedApiService not exported');
                
                // Test OptimizedAIVoiceControl import
                const { OptimizedAIVoiceControl } = await import('./modes/optimized-ai-voice-control.js');
                if (!OptimizedAIVoiceControl) throw new Error('OptimizedAIVoiceControl not exported');
                
                log('All imports successful');
                return true;
            } catch (error) {
                throw new Error(`Import failed: ${error.message}`);
            }
        }

        // Test 2: RingBuffer functionality
        async function testRingBuffer() {
            log('Testing RingBuffer functionality...');
            
            const { RingBuffer } = await import('./utils/audio-utils.js');
            
            // Test basic functionality
            const buffer = new RingBuffer(10);
            
            // Test push and count
            buffer.push([1, 2, 3, 4, 5]);
            if (buffer.count !== 5) throw new Error(`Expected count 5, got ${buffer.count}`);
            
            // Test readLast
            const data = buffer.readLast(3);
            if (data.length !== 3) throw new Error(`Expected length 3, got ${data.length}`);
            if (data[0] !== 3 || data[1] !== 4 || data[2] !== 5) {
                throw new Error(`Expected [3,4,5], got [${data.join(',')}]`);
            }
            
            // Test overflow
            buffer.push([6, 7, 8, 9, 10, 11, 12]);
            if (buffer.count !== 10) throw new Error(`Expected count 10, got ${buffer.count}`);
            
            // Test readAll
            const allData = buffer.readAll();
            if (allData.length !== 10) throw new Error(`Expected length 10, got ${allData.length}`);
            
            log('RingBuffer tests passed');
            return true;
        }

        // Test 3: VAD Processor
        async function testVADProcessor() {
            log('Testing VAD Processor...');
            
            const { OptimizedStreamingProcessor } = await import('./core/optimized-streaming-processor.js');
            
            const processor = new OptimizedStreamingProcessor();
            
            // Test initialization
            if (!processor.audioState) throw new Error('audioState not initialized');
            if (!processor.audioState.vadBuffer) throw new Error('vadBuffer not initialized');
            if (!processor.audioState.speechBuffer) throw new Error('speechBuffer not initialized');
            
            // Test VAD detection with silent audio
            const silentAudio = new Float32Array(1024).fill(0);
            const silentResult = processor.detectVoiceActivity(silentAudio);
            if (silentResult !== false) throw new Error('Silent audio should not trigger VAD');
            
            // Test VAD detection with loud audio
            const loudAudio = new Float32Array(1024).fill(0.1);
            const loudResult = processor.detectVoiceActivity(loudAudio);
            // Note: This might be true or false depending on ZCR, which is fine
            
            // Test efficiency stats
            const stats = processor.getEfficiencyStats();
            if (typeof stats.totalChunksProcessed !== 'number') {
                throw new Error('Efficiency stats not properly formatted');
            }
            
            log('VAD Processor tests passed');
            return true;
        }

        // Test 4: API Service
        async function testApiService() {
            log('Testing API Service...');
            
            const { OptimizedApiService } = await import('./services/optimized-api-service.js');
            
            const apiService = new OptimizedApiService({
                endpoints: {
                    processAudioToPWM: 'https://test-endpoint.com'
                }
            });
            
            // Test initialization
            if (!apiService.conversationState) throw new Error('conversationState not initialized');
            if (apiService.conversationState.currentPwm !== 100) {
                throw new Error('Default PWM should be 100');
            }
            
            // Test state methods
            const state = apiService.getState();
            if (typeof state.isProcessing !== 'boolean') {
                throw new Error('State should include isProcessing boolean');
            }
            
            // Test efficiency stats
            const stats = apiService.getEfficiencyStats();
            if (typeof stats.totalApiCalls !== 'number') {
                throw new Error('Efficiency stats should include totalApiCalls');
            }
            
            // Test conversation history
            const history = apiService.getConversationHistory();
            if (!Array.isArray(history)) {
                throw new Error('Conversation history should be an array');
            }
            
            log('API Service tests passed');
            return true;
        }

        // Test 5: Voice Control Integration
        async function testVoiceControl() {
            log('Testing Voice Control Integration...');
            
            const { OptimizedAIVoiceControl } = await import('./modes/optimized-ai-voice-control.js');
            
            const voiceControl = new OptimizedAIVoiceControl({
                apiEndpoint: 'https://test-endpoint.com'
            });
            
            // Test initialization
            if (!voiceControl.processor) throw new Error('Processor not initialized');
            if (!voiceControl.apiService) throw new Error('API service not initialized');
            if (!voiceControl.state) throw new Error('State not initialized');
            
            // Test configuration
            if (!voiceControl.config) throw new Error('Config not initialized');
            if (typeof voiceControl.config.responseTimeout !== 'number') {
                throw new Error('Config should include responseTimeout');
            }
            
            // Test state methods
            const state = voiceControl.getState();
            if (typeof state.isActive !== 'boolean') {
                throw new Error('State should include isActive boolean');
            }
            
            // Test efficiency stats
            const stats = voiceControl.getEfficiencyStats();
            if (!stats.processor || !stats.api) {
                throw new Error('Efficiency stats should include processor and api stats');
            }
            
            // Test callbacks
            let callbackCalled = false;
            voiceControl.setCallbacks({
                onResponse: () => { callbackCalled = true; }
            });
            
            log('Voice Control Integration tests passed');
            return true;
        }

        // Event handlers
        document.getElementById('testImports').addEventListener('click', () => {
            runAsyncTest('Module Imports', testImports);
        });

        document.getElementById('testRingBuffer').addEventListener('click', () => {
            runAsyncTest('RingBuffer Functionality', testRingBuffer);
        });

        document.getElementById('testVAD').addEventListener('click', () => {
            runAsyncTest('VAD Processor', testVADProcessor);
        });

        document.getElementById('testApiService').addEventListener('click', () => {
            runAsyncTest('API Service', testApiService);
        });

        document.getElementById('testVoiceControl').addEventListener('click', () => {
            runAsyncTest('Voice Control Integration', testVoiceControl);
        });

        document.getElementById('runAllTests').addEventListener('click', async () => {
            log('üöÄ Running all tests...');
            testsRun = 0;
            testsPassed = 0;
            testsFailed = 0;
            updateStats();
            
            await runAsyncTest('Module Imports', testImports);
            await runAsyncTest('RingBuffer Functionality', testRingBuffer);
            await runAsyncTest('VAD Processor', testVADProcessor);
            await runAsyncTest('API Service', testApiService);
            await runAsyncTest('Voice Control Integration', testVoiceControl);
            
            const successRate = Math.round((testsPassed / testsRun) * 100);
            if (successRate === 100) {
                log(`üéâ All tests passed! (${testsPassed}/${testsRun})`, 'success');
            } else {
                log(`‚ö†Ô∏è Tests completed with ${successRate}% success rate (${testsPassed}/${testsRun})`, 'error');
            }
        });

        // Initialize
        log('Test environment ready. Click a test button to begin.');
        updateStats();
    </script>
</body>
</html>