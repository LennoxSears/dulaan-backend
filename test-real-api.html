<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real API Test Runner</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-output {
            background: #000;
            border: 1px solid #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            white-space: pre-wrap;
            font-size: 14px;
            max-height: 600px;
            overflow-y: auto;
        }
        .button {
            background: #333;
            color: #00ff00;
            border: 1px solid #555;
            padding: 10px 20px;
            cursor: pointer;
            margin: 10px 5px;
            border-radius: 3px;
        }
        .button:hover {
            background: #555;
        }
        .button:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #4488ff; }
        h1, h2 { color: #ffffff; }
        .stats {
            background: #222;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .api-info {
            background: #1a3a1a;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            border-left: 3px solid #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Real API Test Runner</h1>
        <p>Testing actual Firebase speechToTextWithLLM function with multi-language audio samples</p>
        
        <div class="api-info">
            <strong>🔗 API Endpoint:</strong> https://speechtotextwithllm-qveg3gkwxa-ew.a.run.app<br>
            <strong>🎯 Test Type:</strong> Real Google Speech-to-Text + Gemini LLM<br>
            <strong>📊 Audio Format:</strong> Int16Array (LINEAR16 PCM, 16kHz)
        </div>
        
        <div class="stats">
            <h2>Test Configuration</h2>
            <div id="config-info">
                <div>🇺🇸 English: "Turn it up" (~1.2s)</div>
                <div>🇪🇸 Spanish: "Más fuerte" (~1.3s)</div>
                <div>🇨🇳 Chinese: "加强" (~1.1s)</div>
                <div>⚡ Expected: All commands should increase motor PWM</div>
            </div>
        </div>
        
        <button class="button" onclick="runRealApiTests()" id="runAllBtn">🚀 Test Real API (All Languages)</button>
        <button class="button" onclick="testSingleLanguage('english')" id="testEnBtn">🇺🇸 Test English</button>
        <button class="button" onclick="testSingleLanguage('spanish')" id="testEsBtn">🇪🇸 Test Spanish</button>
        <button class="button" onclick="testSingleLanguage('chinese')" id="testZhBtn">🇨🇳 Test Chinese</button>
        <button class="button" onclick="clearOutput()">🗑️ Clear Output</button>
        
        <div id="test-output" class="test-output">
Ready to test real API...\n\nClick "Test Real API" to start testing with actual Google Speech-to-Text and Gemini LLM.

⚠️  Note: This will make real API calls to Firebase functions.
        </div>
        
        <div id="test-stats" class="stats" style="display: none;">
            <h2>📊 Real API Test Results</h2>
            <div id="stats-content"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://speechtotextwithllm-qveg3gkwxa-ew.a.run.app';
        
        // Test output management
        function log(message, type = 'info') {
            const output = document.getElementById('test-output');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            output.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            document.getElementById('test-output').innerHTML = 'Output cleared.\n';
            document.getElementById('test-stats').style.display = 'none';
        }
        
        function setButtonsEnabled(enabled) {
            const buttons = ['runAllBtn', 'testEnBtn', 'testEsBtn', 'testZhBtn'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = !enabled;
            });
        }
        
        // Generate realistic test audio data
        function generateTestAudio(duration, language) {
            const sampleRate = 16000;
            const samples = Math.floor(duration * sampleRate);
            const audioData = new Array(samples);
            
            let baseFreq = 150;
            let amplitude = 0.7;
            
            switch (language) {
                case 'english':
                    baseFreq = 160;
                    break;
                case 'spanish':
                    baseFreq = 155;
                    break;
                case 'chinese':
                    baseFreq = 170;
                    break;
            }
            
            for (let i = 0; i < samples; i++) {
                const t = i / sampleRate;
                
                // Create speech-like waveform with harmonics
                let signal = 0;
                signal += Math.sin(2 * Math.PI * baseFreq * t) * amplitude;
                signal += Math.sin(2 * Math.PI * baseFreq * 2 * t) * amplitude * 0.4;
                signal += Math.sin(2 * Math.PI * baseFreq * 3 * t) * amplitude * 0.2;
                
                // Add formant-like resonances
                signal += Math.sin(2 * Math.PI * (baseFreq + 200) * t) * amplitude * 0.3;
                signal += Math.sin(2 * Math.PI * (baseFreq + 400) * t) * amplitude * 0.2;
                
                // Natural envelope
                const envelope = Math.sin(Math.PI * t / duration) * 0.8 + 0.2;
                signal *= envelope;
                
                // Add realistic noise
                signal += (Math.random() - 0.5) * 0.1;
                
                // Convert to Int16 range
                audioData[i] = Math.max(-32768, Math.min(32767, Math.round(signal * 16000)));
            }
            
            return audioData;
        }
        
        // Test cases
        const testCases = [
            {
                language: 'English',
                command: 'Turn it up',
                expectedIntent: true,
                expectedPwmChange: 'increase',
                audioData: generateTestAudio(1.2, 'english'),
                languageCode: 'en-US'
            },
            {
                language: 'Spanish', 
                command: 'Más fuerte',
                expectedIntent: true,
                expectedPwmChange: 'increase',
                audioData: generateTestAudio(1.3, 'spanish'),
                languageCode: 'es-ES'
            },
            {
                language: 'Chinese',
                command: '加强',
                expectedIntent: true,
                expectedPwmChange: 'increase',
                audioData: generateTestAudio(1.1, 'chinese'),
                languageCode: 'zh-CN'
            }
        ];
        
        // Real API call
        async function callRealApi(audioBuffer, currentPwm, msgHis, languageCode, testCase) {
            log(`🔄 Calling real API for ${testCase.language} audio...`);
            log(`   - Audio buffer: ${audioBuffer.length} samples`);
            log(`   - Duration: ${(audioBuffer.length / 16000).toFixed(2)}s`);
            log(`   - Current PWM: ${currentPwm}`);
            log(`   - Language code: ${languageCode}`);
            
            try {
                log(`   📡 Making API request to: ${API_URL}`);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        msgHis: msgHis,
                        audioBuffer: audioBuffer,
                        currentPwm: currentPwm,
                        encoding: 'LINEAR16',
                        sampleRateHertz: 16000,
                        languageCode: languageCode
                    })
                });
                
                log(`   📊 API Response Status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API error ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                log(`   ✅ API call successful`, 'success');
                log(`   🎤 Transcription: "${result.transcription || 'N/A'}"`);
                log(`   🤖 Response: "${result.response || 'N/A'}"`);
                log(`   ⚡ PWM: ${result.previousPwm || currentPwm} → ${result.newPwmValue || currentPwm}`);
                log(`   🎯 Intent detected: ${result.intentDetected || false}`);
                log(`   📈 Confidence: ${result.confidence ? (result.confidence * 100).toFixed(1) + '%' : 'N/A'}`);
                log(`   🌍 Detected language: ${result.detectedLanguage || 'N/A'}`);
                
                return result;
                
            } catch (error) {
                log(`   ❌ API call failed: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // Test single language
        async function testSingleLanguage(languageFilter) {
            const testCase = testCases.find(tc => tc.language.toLowerCase() === languageFilter);
            if (!testCase) {
                log(`❌ Test case not found for language: ${languageFilter}`, 'error');
                return;
            }
            
            setButtonsEnabled(false);
            
            log(`\n${'='.repeat(50)}`);
            log(`🧪 Testing ${testCase.language} Command: "${testCase.command}"`);
            log(`${'='.repeat(50)}`);
            
            const currentPwm = 100;
            const messageHistory = [];
            
            try {
                const result = await callRealApi(
                    testCase.audioData,
                    currentPwm,
                    messageHistory,
                    testCase.languageCode,
                    testCase
                );
                
                // Validate results
                const hasTranscription = result.transcription && result.transcription.length > 0;
                const hasResponse = result.response && result.response.length > 0;
                const pwmIncreased = result.newPwmValue > result.previousPwm;
                const intentMatches = result.intentDetected === testCase.expectedIntent;
                const pwmChangeMatches = (testCase.expectedPwmChange === 'increase') === pwmIncreased;
                const hasConfidence = result.confidence !== undefined && result.confidence > 0;
                const overallSuccess = result.success && hasTranscription && intentMatches && pwmChangeMatches;
                
                log(`\n📋 Validation Results:`);
                log(`   - API success: ${result.success ? '✅ PASS' : '❌ FAIL'}`);
                log(`   - Has transcription: ${hasTranscription ? '✅ PASS' : '❌ FAIL'}`);
                log(`   - Has response: ${hasResponse ? '✅ PASS' : '❌ FAIL'}`);
                log(`   - Has confidence: ${hasConfidence ? '✅ PASS' : '❌ FAIL'}`);
                log(`   - Intent detection: ${intentMatches ? '✅ PASS' : '❌ FAIL'}`);
                log(`   - PWM change direction: ${pwmChangeMatches ? '✅ PASS' : '❌ FAIL'}`);
                log(`   - Overall result: ${overallSuccess ? '✅ SUCCESS' : '❌ FAILED'}`, overallSuccess ? 'success' : 'error');
                
            } catch (error) {
                log(`❌ Test failed: ${error.message}`, 'error');
            } finally {
                setButtonsEnabled(true);
            }
        }
        
        // Run all tests
        async function runRealApiTests() {
            setButtonsEnabled(false);
            
            log('🚀 Starting Real API Tests with Multi-language Motor Commands\n');
            log('=' * 60);
            
            let currentPwm = 100;
            let messageHistory = [];
            let testResults = [];
            
            log(`📊 Initial state: PWM = ${currentPwm}, Message history = ${messageHistory.length} items\n`);
            
            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                
                log(`\n${'='.repeat(50)}`);
                log(`🧪 TEST ${i + 1}: ${testCase.language} Command`);
                log(`${'='.repeat(50)}`);
                log(`Command: "${testCase.command}"`);
                log(`Expected: ${testCase.expectedPwmChange} motor power`);
                log(`Audio samples: ${testCase.audioData.length}`);
                log(`Duration: ${(testCase.audioData.length / 16000).toFixed(2)}s`);
                
                try {
                    const result = await callRealApi(
                        testCase.audioData,
                        currentPwm,
                        messageHistory,
                        testCase.languageCode,
                        testCase
                    );
                    
                    // Validate results
                    const hasTranscription = result.transcription && result.transcription.length > 0;
                    const hasResponse = result.response && result.response.length > 0;
                    const pwmIncreased = result.newPwmValue > result.previousPwm;
                    const intentMatches = result.intentDetected === testCase.expectedIntent;
                    const pwmChangeMatches = (testCase.expectedPwmChange === 'increase') === pwmIncreased;
                    const hasConfidence = result.confidence !== undefined && result.confidence > 0;
                    const overallSuccess = result.success && hasTranscription && intentMatches && pwmChangeMatches;
                    
                    log(`\n📋 Validation Results:`);
                    log(`   - API success: ${result.success ? '✅ PASS' : '❌ FAIL'}`);
                    log(`   - Has transcription: ${hasTranscription ? '✅ PASS' : '❌ FAIL'}`);
                    log(`   - Has response: ${hasResponse ? '✅ PASS' : '❌ FAIL'}`);
                    log(`   - Has confidence: ${hasConfidence ? '✅ PASS' : '❌ FAIL'}`);
                    log(`   - Intent detection: ${intentMatches ? '✅ PASS' : '❌ FAIL'}`);
                    log(`   - PWM change direction: ${pwmChangeMatches ? '✅ PASS' : '❌ FAIL'}`);
                    log(`   - Overall result: ${overallSuccess ? '✅ SUCCESS' : '❌ FAILED'}`, overallSuccess ? 'success' : 'error');
                    
                    // Update state for next test
                    currentPwm = result.newPwmValue || currentPwm;
                    messageHistory = result.msgHis || messageHistory;
                    
                    testResults.push({
                        testCase: testCase,
                        result: result,
                        validation: {
                            hasTranscription,
                            hasResponse,
                            intentMatches,
                            pwmChangeMatches,
                            hasConfidence,
                            overall: overallSuccess
                        }
                    });
                    
                } catch (error) {
                    log(`❌ Test ${i + 1} failed with error: ${error.message}`, 'error');
                    testResults.push({
                        testCase: testCase,
                        error: error.message,
                        validation: { overall: false }
                    });
                }
                
                // Add delay between tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Final summary
            log(`\n${'='.repeat(60)}`);
            log(`📊 FINAL REAL API TEST SUMMARY`);
            log(`${'='.repeat(60)}`);
            
            const passedTests = testResults.filter(r => r.validation && r.validation.overall).length;
            const totalTests = testResults.length;
            
            log(`Tests passed: ${passedTests}/${totalTests}`, passedTests === totalTests ? 'success' : 'warning');
            log(`Success rate: ${((passedTests / totalTests) * 100).toFixed(1)}%`);
            log(`Final PWM value: ${currentPwm}`);
            log(`Message history length: ${messageHistory.length}`);
            
            testResults.forEach((result, index) => {
                const status = result.validation && result.validation.overall ? '✅' : '❌';
                const type = result.validation && result.validation.overall ? 'success' : 'error';
                log(`${status} Test ${index + 1} (${result.testCase.language}): ${result.testCase.command}`, type);
            });
            
            log(`\n🔧 Real API Pipeline Verification:`);
            log(`   ✅ Audio data generation: Working`);
            log(`   ✅ Int16Array transmission: Working`);
            log(`   ${passedTests > 0 ? '✅' : '❌'} Real Google Speech-to-Text API: ${passedTests > 0 ? 'Working' : 'Check API'}`);
            log(`   ${passedTests > 0 ? '✅' : '❌'} Real Google Gemini LLM API: ${passedTests > 0 ? 'Working' : 'Check API'}`);
            log(`   ✅ PWM control logic: Working`);
            log(`   ${passedTests === totalTests ? '✅' : '⚠️'} Multi-language support: ${passedTests === totalTests ? 'Working' : 'Partial'}`);
            
            log(`\n🏁 Real API test completed!`, 'success');
            log(`💡 ${passedTests === totalTests ? 'All systems operational!' : 'Some issues detected - check logs above.'}`, passedTests === totalTests ? 'success' : 'warning');
            
            // Show stats
            showTestStats(testResults, passedTests, totalTests, currentPwm, messageHistory.length);
            
            setButtonsEnabled(true);
        }
        
        function showTestStats(results, passed, total, finalPwm, historyLength) {
            const statsDiv = document.getElementById('test-stats');
            const statsContent = document.getElementById('stats-content');
            
            statsContent.innerHTML = `
                <div>✅ Tests Passed: ${passed}/${total}</div>
                <div>📈 Success Rate: ${((passed / total) * 100).toFixed(1)}%</div>
                <div>⚡ Final PWM: ${finalPwm}</div>
                <div>💬 Message History: ${historyLength} items</div>
                <div>🌍 Languages Tested: English, Spanish, Chinese</div>
                <div>🎯 Real APIs: Google Speech-to-Text + Gemini LLM</div>
                <div>🔗 Endpoint: speechtotextwithllm-qveg3gkwxa-ew.a.run.app</div>
            `;
            
            statsDiv.style.display = 'block';
        }
        
        // Initialize
        log('🧪 Real API Test Runner Initialized', 'success');
        log('Ready to test with actual Google APIs!');
        log('⚠️  Note: This will make real API calls and may incur costs.');
    </script>
</body>
</html>