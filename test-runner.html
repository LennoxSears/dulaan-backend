<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Pipeline Test Runner</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-output {
            background: #000;
            border: 1px solid #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            white-space: pre-wrap;
            font-size: 14px;
            max-height: 600px;
            overflow-y: auto;
        }
        .button {
            background: #333;
            color: #00ff00;
            border: 1px solid #555;
            padding: 10px 20px;
            cursor: pointer;
            margin: 10px 5px;
            border-radius: 3px;
        }
        .button:hover {
            background: #555;
        }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #4488ff; }
        h1, h2 { color: #ffffff; }
        .stats {
            background: #222;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Speech Pipeline Test Runner</h1>
        <p>Multi-language Motor Command Testing Suite</p>
        
        <div class="stats">
            <h2>Test Configuration</h2>
            <div id="config-info">
                <div>📊 Test Cases: 3 (English, Spanish, Chinese)</div>
                <div>🎯 Target: Motor control commands</div>
                <div>🔧 Pipeline: Audio → Speech-to-Text → LLM → PWM</div>
                <div>⚡ Sample Rate: 16kHz</div>
            </div>
        </div>
        
        <button class="button" onclick="runAllTests()">🚀 Run All Tests</button>
        <button class="button" onclick="runSingleTest('english')">🇺🇸 Test English</button>
        <button class="button" onclick="runSingleTest('spanish')">🇪🇸 Test Spanish</button>
        <button class="button" onclick="runSingleTest('chinese')">🇨🇳 Test Chinese</button>
        <button class="button" onclick="clearOutput()">🗑️ Clear Output</button>
        
        <div id="test-output" class="test-output">
Ready to run tests...\n\nClick "Run All Tests" to start the comprehensive test suite.
        </div>
        
        <div id="test-stats" class="stats" style="display: none;">
            <h2>📊 Test Results Summary</h2>
            <div id="stats-content"></div>
        </div>
    </div>

    <script>
        // Test output management
        function log(message, type = 'info') {
            const output = document.getElementById('test-output');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            output.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            document.getElementById('test-output').innerHTML = 'Output cleared.\n';
            document.getElementById('test-stats').style.display = 'none';
        }
        
        // Audio data generation
        function generateTestAudio(duration, language) {
            const sampleRate = 16000;
            const samples = Math.floor(duration * sampleRate);
            const audioData = new Array(samples);
            
            let baseFreq = 150;
            let amplitude = 0.7;
            
            switch (language) {
                case 'english':
                    baseFreq = 160;
                    break;
                case 'spanish':
                    baseFreq = 155;
                    break;
                case 'chinese':
                    baseFreq = 170;
                    break;
            }
            
            for (let i = 0; i < samples; i++) {
                const t = i / sampleRate;
                
                let signal = 0;
                signal += Math.sin(2 * Math.PI * baseFreq * t) * amplitude;
                signal += Math.sin(2 * Math.PI * baseFreq * 2 * t) * amplitude * 0.4;
                signal += Math.sin(2 * Math.PI * baseFreq * 3 * t) * amplitude * 0.2;
                
                const envelope = Math.sin(Math.PI * t / duration) * 0.8 + 0.2;
                signal *= envelope;
                
                signal += (Math.random() - 0.5) * 0.1;
                
                audioData[i] = Math.max(-32768, Math.min(32767, Math.round(signal * 16000)));
            }
            
            return audioData;
        }
        
        // Test cases
        const testCases = [
            {
                language: 'English',
                command: 'Turn it up',
                expectedIntent: true,
                expectedPwmChange: 'increase',
                audioData: generateTestAudio(1.2, 'english'),
                languageCode: 'en-US'
            },
            {
                language: 'Spanish', 
                command: 'Más fuerte',
                expectedIntent: true,
                expectedPwmChange: 'increase',
                audioData: generateTestAudio(1.3, 'spanish'),
                languageCode: 'es-ES'
            },
            {
                language: 'Chinese',
                command: '加强',
                expectedIntent: true,
                expectedPwmChange: 'increase',
                audioData: generateTestAudio(1.1, 'chinese'),
                languageCode: 'zh-CN'
            }
        ];
        
        // Simulate API processing
        async function simulateSpeechToTextWithLLM(audioBuffer, currentPwm, msgHis, languageCode) {
            log(`🔄 Processing audio buffer (${audioBuffer.length} samples)...`);
            
            // Simulate processing delay
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Convert array to Int16Array (server-side simulation)
            const int16Data = new Int16Array(audioBuffer);
            log(`✅ Converted to Int16Array: ${int16Data.length} samples`);
            
            const bufferSize = int16Data.buffer.byteLength;
            log(`✅ Buffer size: ${bufferSize} bytes`);
            
            // Simulate speech recognition
            let transcript = '';
            let confidence = 0.85;
            
            switch (languageCode) {
                case 'en-US':
                    transcript = 'turn it up';
                    break;
                case 'es-ES':
                    transcript = 'más fuerte';
                    break;
                case 'zh-CN':
                    transcript = '加强';
                    break;
                default:
                    transcript = 'unknown command';
                    confidence = 0.2;
            }
            
            log(`🎤 Speech recognition: "${transcript}" (confidence: ${(confidence * 100).toFixed(1)}%)`, 'success');
            
            // Simulate LLM processing
            let newPwmValue = currentPwm;
            let intentDetected = false;
            let response = '';
            
            if (confidence > 0.3) {
                intentDetected = true;
                newPwmValue = Math.min(255, currentPwm + 50);
                
                switch (languageCode) {
                    case 'en-US':
                        response = 'Increasing motor power as requested.';
                        break;
                    case 'es-ES':
                        response = 'Aumentando la potencia del motor como solicitaste.';
                        break;
                    case 'zh-CN':
                        response = '正在按要求增加电机功率。';
                        break;
                }
            } else {
                response = 'I didn\'t understand that command clearly.';
            }
            
            log(`🤖 LLM processing: Intent=${intentDetected}, PWM: ${currentPwm} → ${newPwmValue}`, 'success');
            
            return {
                success: true,
                transcription: transcript,
                response: response,
                reasoning: intentDetected ? 'Clear motor control command detected' : 'No clear intent detected',
                newPwmValue: newPwmValue,
                previousPwm: currentPwm,
                intentDetected: intentDetected,
                msgHis: [...msgHis, {
                    user: transcript,
                    assistant: response,
                    pwm: newPwmValue,
                    intentDetected: intentDetected,
                    timestamp: new Date().toISOString()
                }],
                detectedLanguage: languageCode,
                confidence: confidence
            };
        }
        
        // Run single test
        async function runSingleTest(languageFilter) {
            const testCase = testCases.find(tc => tc.language.toLowerCase() === languageFilter);
            if (!testCase) {
                log(`❌ Test case not found for language: ${languageFilter}`, 'error');
                return;
            }
            
            log(`\n${'='.repeat(50)}`);
            log(`🧪 Testing ${testCase.language} Command: "${testCase.command}"`);
            log(`${'='.repeat(50)}`);
            
            const currentPwm = 100;
            const messageHistory = [];
            
            try {
                const result = await simulateSpeechToTextWithLLM(
                    testCase.audioData,
                    currentPwm,
                    messageHistory,
                    testCase.languageCode
                );
                
                log(`\n📋 Results:`);
                log(`   - Transcription: "${result.transcription}"`);
                log(`   - Response: "${result.response}"`);
                log(`   - Intent detected: ${result.intentDetected ? '✅' : '❌'}`);
                log(`   - PWM change: ${result.previousPwm} → ${result.newPwmValue} (${result.newPwmValue > result.previousPwm ? '+' : ''}${result.newPwmValue - result.previousPwm})`);
                log(`   - Confidence: ${(result.confidence * 100).toFixed(1)}%`);
                
                const success = result.intentDetected && result.newPwmValue > result.previousPwm;
                log(`\n✅ Test Result: ${success ? 'SUCCESS' : 'FAILED'}`, success ? 'success' : 'error');
                
            } catch (error) {
                log(`❌ Test failed: ${error.message}`, 'error');
            }
        }
        
        // Run all tests
        async function runAllTests() {
            log('🚀 Starting Comprehensive Speech Pipeline Test\n');
            log('=' * 60);
            
            let currentPwm = 100;
            let messageHistory = [];
            let testResults = [];
            
            log(`📊 Initial state: PWM = ${currentPwm}, Message history = ${messageHistory.length} items\n`);
            
            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                
                log(`\n${'='.repeat(50)}`);
                log(`🧪 TEST ${i + 1}: ${testCase.language} Command`);
                log(`${'='.repeat(50)}`);
                log(`Command: "${testCase.command}"`);
                log(`Expected: ${testCase.expectedPwmChange} motor power`);
                log(`Audio samples: ${testCase.audioData.length}`);
                log(`Duration: ${(testCase.audioData.length / 16000).toFixed(2)}s`);
                
                try {
                    const result = await simulateSpeechToTextWithLLM(
                        testCase.audioData,
                        currentPwm,
                        messageHistory,
                        testCase.languageCode
                    );
                    
                    log(`\n📋 Results Analysis:`);
                    log(`   - Transcription: "${result.transcription}"`);
                    log(`   - Response: "${result.response}"`);
                    log(`   - Intent detected: ${result.intentDetected ? '✅' : '❌'}`);
                    log(`   - PWM change: ${result.previousPwm} → ${result.newPwmValue} (${result.newPwmValue > result.previousPwm ? '+' : ''}${result.newPwmValue - result.previousPwm})`);
                    log(`   - Confidence: ${(result.confidence * 100).toFixed(1)}%`);
                    log(`   - Language detected: ${result.detectedLanguage}`);
                    
                    const pwmIncreased = result.newPwmValue > result.previousPwm;
                    const intentMatches = result.intentDetected === testCase.expectedIntent;
                    const pwmChangeMatches = (testCase.expectedPwmChange === 'increase') === pwmIncreased;
                    
                    log(`\n✅ Validation:`);
                    log(`   - Intent detection: ${intentMatches ? '✅ PASS' : '❌ FAIL'}`);
                    log(`   - PWM change direction: ${pwmChangeMatches ? '✅ PASS' : '❌ FAIL'}`);
                    log(`   - Overall: ${(intentMatches && pwmChangeMatches) ? '✅ SUCCESS' : '❌ FAILED'}`, (intentMatches && pwmChangeMatches) ? 'success' : 'error');
                    
                    currentPwm = result.newPwmValue;
                    messageHistory = result.msgHis;
                    
                    testResults.push({
                        testCase: testCase,
                        result: result,
                        validation: {
                            intentMatches,
                            pwmChangeMatches,
                            overall: intentMatches && pwmChangeMatches
                        }
                    });
                    
                } catch (error) {
                    log(`❌ Test ${i + 1} failed with error: ${error.message}`, 'error');
                    testResults.push({
                        testCase: testCase,
                        error: error.message,
                        validation: { overall: false }
                    });
                }
                
                // Add delay between tests
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // Final summary
            log(`\n${'='.repeat(60)}`);
            log(`📊 FINAL TEST SUMMARY`);
            log(`${'='.repeat(60)}`);
            
            const passedTests = testResults.filter(r => r.validation && r.validation.overall).length;
            const totalTests = testResults.length;
            
            log(`Tests passed: ${passedTests}/${totalTests}`, passedTests === totalTests ? 'success' : 'warning');
            log(`Success rate: ${((passedTests / totalTests) * 100).toFixed(1)}%`);
            log(`Final PWM value: ${currentPwm}`);
            log(`Message history length: ${messageHistory.length}`);
            
            testResults.forEach((result, index) => {
                const status = result.validation && result.validation.overall ? '✅' : '❌';
                const type = result.validation && result.validation.overall ? 'success' : 'error';
                log(`${status} Test ${index + 1} (${result.testCase.language}): ${result.testCase.command}`, type);
            });
            
            log(`\n🏁 Test completed!`, 'success');
            
            // Show stats
            showTestStats(testResults, passedTests, totalTests, currentPwm, messageHistory.length);
        }
        
        function showTestStats(results, passed, total, finalPwm, historyLength) {
            const statsDiv = document.getElementById('test-stats');
            const statsContent = document.getElementById('stats-content');
            
            statsContent.innerHTML = `
                <div>✅ Tests Passed: ${passed}/${total}</div>
                <div>📈 Success Rate: ${((passed / total) * 100).toFixed(1)}%</div>
                <div>⚡ Final PWM: ${finalPwm}</div>
                <div>💬 Message History: ${historyLength} items</div>
                <div>🌍 Languages Tested: English, Spanish, Chinese</div>
                <div>🎯 All Commands: Motor increase commands</div>
            `;
            
            statsDiv.style.display = 'block';
        }
        
        // Initialize
        log('🧪 Speech Pipeline Test Runner Initialized', 'success');
        log('Ready to test multi-language motor commands!');
    </script>
</body>
</html>